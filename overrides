#!/bin/bash
#
# overrides - Manage omarchy config overrides
#
# This script helps keep your custom omarchy configs in sync with this repo.
# Use it to backup your configs to git, or restore them after an omarchy update.
#
# Usage:
#   ./overrides sync      Sync current ~/.config/ files into this repo
#   ./overrides restore   Restore files from this repo to ~/.config/
#   ./overrides help      Show this help message
#
# After syncing, don't forget to commit and push:
#   git add -A && git commit -m "Update configs" && git push
#

set -e

# Get the directory where this script lives (the repo root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ---------------------------------------------------------------------------
# CONFIG ENTRIES
# ---------------------------------------------------------------------------
# Format: "display_name:repo_path:config_path[:type]"
#
#   display_name  - Human-readable name shown in output
#   repo_path     - Path in this repo (file or directory)
#   config_path   - Path under ~/.config/ to sync from/to
#   type          - Optional: "dir" (default) or "file"
#
# To add a new config, simply add a new entry to this array.
# Examples:
#   "waybar:waybar:waybar"              - ~/.config/waybar/ <-> ./waybar/
#   "AGENTS.md:AGENTS.md:AGENTS.md:file" - ~/.config/AGENTS.md <-> ./AGENTS.md
# ---------------------------------------------------------------------------
CONFIGS=(
    "agents:agents:agents"
    "hypr:hypr:hypr"
    "ghostty:ghostty:ghostty"
    "AGENTS.md:AGENTS.md:AGENTS.md:file"
)

# ---------------------------------------------------------------------------
# FUNCTIONS
# ---------------------------------------------------------------------------

show_help() {
    echo "Usage: ./overrides <command>"
    echo ""
    echo "Commands:"
    echo "  sync      Sync current ~/.config/ files into this repo"
    echo "  restore   Restore files from this repo to ~/.config/"
    echo "  help      Show this help message"
}

do_sync() {
    echo "Syncing omarchy configs to repo..."

    for entry in "${CONFIGS[@]}"; do
        # Split the entry by ':' into separate variables (type defaults to "dir")
        IFS=':' read -r name repo_path config_path entry_type <<< "$entry"
        entry_type="${entry_type:-dir}"

        if [ "$entry_type" = "file" ]; then
            # Handle single file
            if [ -f "$HOME/.config/$config_path" ]; then
                # Ensure parent directory exists in repo
                mkdir -p "$(dirname "$SCRIPT_DIR/$repo_path")"
                rsync -a --exclude='*.bak*' "$HOME/.config/$config_path" "$SCRIPT_DIR/$repo_path"
                echo "  - Synced $name"
            fi
        else
            # Handle directory
            if [ -d "$HOME/.config/$config_path" ]; then
                # Ensure target directory exists in repo
                mkdir -p "$SCRIPT_DIR/$repo_path"

                # Use rsync to copy files:
                #   -a           : Archive mode (preserves permissions, timestamps, etc.)
                #   --exclude    : Skip backup files created by omarchy (*.bak*)
                #   trailing /   : Copy contents, not the directory itself
                rsync -a --exclude='*.bak*' "$HOME/.config/$config_path/" "$SCRIPT_DIR/$repo_path/"

                echo "  - Synced $name"
            fi
        fi
    done

    echo "Done! Don't forget to commit and push your changes."
}

do_restore() {
    echo "Restoring omarchy overrides..."

    for entry in "${CONFIGS[@]}"; do
        # Split the entry by ':' into separate variables (type defaults to "dir")
        IFS=':' read -r name repo_path config_path entry_type <<< "$entry"
        entry_type="${entry_type:-dir}"

        if [ "$entry_type" = "file" ]; then
            # Handle single file
            if [ -f "$SCRIPT_DIR/$repo_path" ]; then
                # Ensure parent directory exists
                mkdir -p "$(dirname "$HOME/.config/$config_path")"
                rsync -a "$SCRIPT_DIR/$repo_path" "$HOME/.config/$config_path"
                echo "  - Restored $name"
            fi
        else
            # Handle directory
            if [ -d "$SCRIPT_DIR/$repo_path" ]; then
                # Ensure target directory exists
                mkdir -p "$HOME/.config/$config_path"

                rsync -a "$SCRIPT_DIR/$repo_path/" "$HOME/.config/$config_path/"

                echo "  - Restored $name"
            fi
        fi
    done

    # Reload hyprland to apply changes immediately (if it's running)
    if command -v hyprctl &> /dev/null && hyprctl monitors &> /dev/null; then
        hyprctl reload
        echo "  - Reloaded hyprland"
    fi

    echo "Done!"
}

# ---------------------------------------------------------------------------
# MAIN
# ---------------------------------------------------------------------------

case "${1:-}" in
    sync)
        do_sync
        ;;
    restore)
        do_restore
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        echo "Error: No command specified"
        echo ""
        show_help
        exit 1
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
