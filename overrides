#!/bin/bash
#
# overrides - Manage omarchy config overrides
#
# Sync and restore configured absolute paths into this repo.
# Paths are mirrored under ./configs/ and symlinks are preserved.
# Example: /home/user/.config/AGENTS.md stays a symlink in configs/.
# Use it to backup your overrides to git, or restore them after an omarchy update.
#
# Usage:
#   ./overrides sync [--dry-run]       Sync configured absolute paths into this repo
#   ./overrides restore [--force] [--dry-run]  Restore files to their original absolute paths
#   ./overrides help                   Show this help message
#
# After syncing, don't forget to commit and push:
#   git add -A && git commit -m "Update configs" && git push
#

set -euo pipefail
IFS=$'\n\t'

# Get the directory where this script lives (the repo root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Repo stores configs under configs/ subdirectory
REPO_CONFIG_DIR="$SCRIPT_DIR/configs"

# ---------------------------------------------------------------------------
# CONFIG ENTRIES
# ---------------------------------------------------------------------------
# Absolute paths to sync. Files, directories, and symlinks are supported.
# Each path is mirrored under ./configs/ in the repo.
#
# Examples:
#   "/home/user/.config/waybar"    - configs/home/user/.config/waybar/
#   "/home/user/.config/AGENTS.md" - configs/home/user/.config/AGENTS.md
# ---------------------------------------------------------------------------
CONFIGS=(
    "$HOME/.claude/skills"                  # both amp and opencode support cc skills
    "$HOME/.config/agents/docs"
    "$HOME/.config/hypr"
    "$HOME/.config/ghostty"
    "$HOME/.config/amp/settings.json"       # amp global settings
    "$HOME/.config/AGENTS.md"               # amp global agents.md
    "$HOME/.config/opencode/AGENTS.md"      # opencode global agents.md
)

# ---------------------------------------------------------------------------
# GLOBALS
# ---------------------------------------------------------------------------
DRY_RUN=false
FORCE=false

# ---------------------------------------------------------------------------
# FUNCTIONS
# ---------------------------------------------------------------------------

die() {
    echo "Error: $*" >&2
    exit 1
}

show_help() {
    echo "Usage: ./overrides <command> [options]"
    echo ""
    echo "Commands:"
    echo "  sync      Sync configured absolute paths into this repo"
    echo "  restore   Restore files to their original absolute paths"
    echo "  help      Show this help message"
    echo ""
    echo "Options:"
    echo "  --dry-run   Show what would be done without making changes"
    echo "  --force     Skip confirmation prompt (restore only)"
    echo ""
    echo "Example:"
    echo "  /home/user/.config/waybar -> configs/home/user/.config/waybar"
    echo "  /home/user/.config/AGENTS.md -> configs/home/user/.config/AGENTS.md (symlink preserved)"
}

validate_environment() {
    # Refuse to run as root
    if [[ ${EUID:-1000} -eq 0 ]]; then
        die "This script must not be run as root"
    fi

    # Validate HOME
    if [[ -z "${HOME:-}" ]]; then
        die "\$HOME is not set"
    fi
    if [[ ! -d "$HOME" ]]; then
        die "\$HOME ($HOME) is not a directory"
    fi
    if [[ "$HOME" == "/" ]]; then
        die "\$HOME cannot be /"
    fi
}

validate_config_entry() {
    local entry="$1"

    # Reject empty strings
    if [[ -z "$entry" ]]; then
        die "Empty config entry found"
    fi

    # Require absolute paths
    if [[ "$entry" != /* ]]; then
        die "Config entry must be an absolute path: $entry"
    fi

    # Reject "."
    if [[ "$entry" == "." ]]; then
        die "Config entry cannot be '.'"
    fi

    # Reject entries containing ".."
    if [[ "$entry" == *..* ]]; then
        die "Config entry cannot contain '..': $entry"
    fi
}

# Shared rsync helper
# Usage: do_rsync <src> <dest> [--backup <backup_dir>]
# Preserves symlinks rather than copying targets.
do_rsync() {
    local src="$1"
    local dest="$2"
    local use_backup="${3:-}"
    local backup_dir="${4:-}"

    local rsync_opts=(-a --exclude='*.bak*')

    if [[ "$DRY_RUN" == true ]]; then
        rsync_opts+=(-n --itemize-changes)
    fi

    if [[ "$use_backup" == "--backup" && -n "$backup_dir" ]]; then
        rsync_opts+=(--backup "--backup-dir=$backup_dir")
    fi

    mkdir -p "$(dirname "$dest")"

    if [[ -d "$src" ]]; then
        mkdir -p "$dest"
        rsync "${rsync_opts[@]}" "$src/" "$dest/"
    else
        rsync "${rsync_opts[@]}" "$src" "$dest"
    fi
}

do_sync() {
    echo "Syncing omarchy configs to repo..."
    if [[ "$DRY_RUN" == true ]]; then
        echo "(dry-run mode - no changes will be made)"
    fi

    for path in "${CONFIGS[@]}"; do
        validate_config_entry "$path"

        local src="$path"
        local dest="$REPO_CONFIG_DIR${path}"

        if [[ -e "$src" ]]; then
            do_rsync "$src" "$dest"
            echo "  - Synced $path"
        fi
    done

    if [[ "$DRY_RUN" == true ]]; then
        echo "Dry run complete. No changes were made."
    else
        echo "Done! Don't forget to commit and push your changes."
    fi
}

do_restore() {
    echo "Restoring omarchy overrides..."

    # Confirmation prompt unless --force
    if [[ "$FORCE" != true && "$DRY_RUN" != true ]]; then
        echo ""
        echo "This will overwrite files at their original absolute paths with files from this repo."
        echo "A backup will be created in ~/.config/.overrides-backup/"
        echo ""
        read -rp "Continue? [y/N] " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 0
        fi
    fi

    if [[ "$DRY_RUN" == true ]]; then
        echo "(dry-run mode - no changes will be made)"
    fi

    # Generate backup directory once for the entire restore operation
    # Backups mirror the absolute paths under ~/.config/.overrides-backup/
    local backup_dir="$HOME/.config/.overrides-backup/$(date +%Y%m%d-%H%M%S)"
    if [[ "$DRY_RUN" != true ]]; then
        mkdir -p "$backup_dir"
    fi

    for path in "${CONFIGS[@]}"; do
        validate_config_entry "$path"

        local src="$REPO_CONFIG_DIR${path}"
        local dest="$path"

        if [[ -e "$src" ]]; then
            local path_backup_dir="$backup_dir${path}"
            if [[ "$DRY_RUN" != true ]]; then
                mkdir -p "$path_backup_dir"
            fi
            do_rsync "$src" "$dest" --backup "$path_backup_dir"
            echo "  - Restored $path"
        fi
    done

    # Reload hyprland to apply changes immediately (if it's running)
    if [[ "$DRY_RUN" != true ]]; then
        if command -v hyprctl &> /dev/null && hyprctl monitors &> /dev/null; then
            hyprctl reload
            echo "  - Reloaded hyprland"
        fi
    fi

    if [[ "$DRY_RUN" == true ]]; then
        echo "Dry run complete. No changes were made."
    else
        echo "Done!"
    fi
}

parse_flags() {
    for arg in "$@"; do
        case "$arg" in
            --dry-run)
                DRY_RUN=true
                ;;
            --force)
                FORCE=true
                ;;
            *)
                die "Unknown option: $arg"
                ;;
        esac
    done
}

# ---------------------------------------------------------------------------
# MAIN
# ---------------------------------------------------------------------------

validate_environment

case "${1:-}" in
    sync)
        shift || true
        parse_flags "$@"
        do_sync
        ;;
    restore)
        shift || true
        parse_flags "$@"
        do_restore
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        echo "Error: No command specified"
        echo ""
        show_help
        exit 1
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
